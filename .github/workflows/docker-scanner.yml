# name: Docker Scanner CI/CD

# on:
#   workflow_dispatch:

# jobs:
#   scan:
#     runs-on: ubuntu-latest

#     steps:
#       - name: ğŸ”¥ Checkout Repository
#         uses: actions/checkout@v4

#       - name: ğŸ³ Ensure Docker Daemon is Running
#         run: |
#           echo "ğŸ”¹ Checking Docker status..."
#           sudo systemctl start docker
#           sleep 5
#           docker info || (echo "ğŸš¨ ERROR: Docker is not running!" && exit 1)

#       - name: ğŸ³ Load Uploaded Docker Image
#         run: |
#           UPLOADED_FILE=$(ls uploaded_images/*.tar | head -n 1)
#           if [ -z "$UPLOADED_FILE" ]; then
#             echo "ğŸš¨ ERROR: No Docker image tar file found!"
#             exit 1
#           fi
#           echo "âœ… Found uploaded Docker image: $UPLOADED_FILE"
#           docker load -i "$UPLOADED_FILE"

#       - name: ğŸ” Extract Latest Image Name
#         id: extract_image
#         run: |
#           IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n 1)
#           if [ -z "$IMAGE_NAME" ]; then
#             echo "ğŸš¨ ERROR: No valid Docker image found!"
#             exit 1
#           fi
#           echo "âœ… Extracted image name: $IMAGE_NAME"
#           echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

#       - name: ğŸ” Ensure `scan_reports` Directory Exists
#         run: |
#           mkdir -p scan_reports
#           echo "âœ… Created scan_reports directory if missing."

#       - name: ğŸ” Scan with Trivy
#         run: |
#           IMAGE="${{ env.IMAGE_NAME }}"
#           echo "ğŸ”¹ Running Trivy scan on $IMAGE..."
#           docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --scanners vuln "$IMAGE" > "trivy-${IMAGE//[:\/]/_}.txt" || echo "âš ï¸ Trivy scan failed!"
#           echo "âœ… Trivy report saved: scan_reports/trivy-${IMAGE//[:\/]/_}.txt"

#       - name: ğŸ” Scan with Grype
#         run: |
#           IMAGE="${{ env.IMAGE_NAME }}"
#           echo "ğŸ”¹ Running Grype scan on $IMAGE..."
#           docker run --rm -v /var/run/docker.sock:/var/run/docker.sock anchore/grype "$IMAGE" > "grype-${IMAGE//[:\/]/_}.txt" || echo "âš ï¸ Grype scan failed!"
#           echo "âœ… Grype report saved: scan_reports/grype-${IMAGE//[:\/]/_}.txt"

#       - name: ğŸ” Ensure Scan Reports Exist
#         run: |
#           if ls trivy-*.txt 1> /dev/null 2>&1 && ls grype-*.txt 1> /dev/null 2>&1; then
#             echo "âœ… Scan reports found!"
#           else
#             echo "âŒ ERROR: Scan reports are missing!"
#             exit 1
#           fi




#       - name: ğŸ“¤ Upload Scan Reports as Artifacts
#         uses: actions/upload-artifact@v4
#         with:
#           name: Scanner Reports
#           path: |
#             trivy-*.txt
#             grype-*.txt


#   store-in-db:
#     runs-on: ubuntu-latest
#     needs: scan

#     services:
#       mysql:
#         image: mysql:latest
#         env:
#           MYSQL_ROOT_PASSWORD: rootpassword
#           MYSQL_DATABASE: docker_management
#           MYSQL_USER: flask_user
#           MYSQL_PASSWORD: Abhiram@1729
#         ports:
#           - 3306:3306
#         options: >-
#           --health-cmd="mysqladmin ping --host=localhost --user=flask_user --password=Abhiram@1729"
#           --health-interval=10s
#           --health-timeout=5s
#           --health-retries=5

#     steps:
#       - name: ğŸ”¥ Checkout Repository
#         uses: actions/checkout@v4

#       - name: ğŸ“¥ Download Scan Reports
#         uses: actions/download-artifact@v4
#         with:
#           name: Scanner Reports

#       - name: ğŸ” Verify Scan Reports Exist
#         run: |
#           echo "ğŸ”¹ Checking for scan reports in current directory..."
#           ifconfig
          
#           # Check if Trivy and Grype reports exist in the current directory
#           TRIVY_REPORT=$(ls trivy-*.txt 2>/dev/null || echo "")
#           GRYPE_REPORT=$(ls grype-*.txt 2>/dev/null || echo "")

#           if [ -z "$TRIVY_REPORT" ] && [ -z "$GRYPE_REPORT" ]; then
#             echo "âŒ ERROR: No scan reports found!"
#             exit 1
#           else
#             echo "âœ… Scan reports found: $TRIVY_REPORT $GRYPE_REPORT"
#             echo "Proceeding with database insertion..."
#           fi



#       - name: ğŸ›  Install MySQL Connector
#         run: |
#           python -m pip install --upgrade pip
#           pip install mysql-connector-python

#       - name: ğŸ—„ Wait for MySQL to Be Ready
#         run: |
#           for i in {1..30}; do
#             if mysql -h 127.0.0.1 -u flask_user -pAbhiram@1729 -e "SELECT 1"; then
#               echo "âœ… MySQL is ready!"
#               break
#             fi
#             echo "â³ Waiting for MySQL..."
#             sleep 2
#           done

#       - name: ğŸ—„ Store Scan Data in MySQL
#         run: python insert_scan_report.py


name: Docker Scanner CI/CD

on:
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ³ Ensure Docker Daemon is Running
        run: |
          echo "ğŸ”¹ Checking Docker status..."
          sudo systemctl start docker
          sleep 5
          docker info || (echo "ğŸš¨ ERROR: Docker is not running!" && exit 1)

      - name: ğŸ³ Load Uploaded Docker Image
        run: |
          UPLOADED_FILE=$(ls uploaded_images/*.tar | head -n 1)
          if [ -z "$UPLOADED_FILE" ]; then
            echo "ğŸš¨ ERROR: No Docker image tar file found!"
            exit 1
          fi
          echo "âœ… Found uploaded Docker image: $UPLOADED_FILE"
          docker load -i "$UPLOADED_FILE"

      - name: ğŸ” Extract Latest Image Name
        id: extract_image
        run: |
          IMAGE_NAME=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n 1)
          if [ -z "$IMAGE_NAME" ]; then
            echo "ğŸš¨ ERROR: No valid Docker image found!"
            exit 1
          fi
          echo "âœ… Extracted image name: $IMAGE_NAME"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: ğŸ” Ensure `scan_reports` Directory Exists
        run: |
          mkdir -p scan_reports
          echo "âœ… Created scan_reports directory if missing."

      - name: ğŸ” Scan with Trivy
        run: |
          IMAGE="${{ env.IMAGE_NAME }}"
          echo "ğŸ”¹ Running Trivy scan on $IMAGE..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --scanners vuln "$IMAGE" > "scan_reports/trivy-${IMAGE//[:\/]/_}.txt" || echo "âš ï¸ Trivy scan failed!"
          echo "âœ… Trivy report saved: scan_reports/trivy-${IMAGE//[:\/]/_}.txt"

      - name: ğŸ” Scan with Grype
        run: |
          IMAGE="${{ env.IMAGE_NAME }}"
          echo "ğŸ”¹ Running Grype scan on $IMAGE..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock anchore/grype "$IMAGE" > "scan_reports/grype-${IMAGE//[:\/]/_}.txt" || echo "âš ï¸ Grype scan failed!"
          echo "âœ… Grype report saved: scan_reports/grype-${IMAGE//[:\/]/_}.txt"

      - name: ğŸ“¤ Upload Scan Reports as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Scanner Reports
          path: scan_reports/*.txt


 store-in-db:
  runs-on: ubuntu-latest
  needs: scan

  steps:
    - name: ğŸ”¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download Scan Reports
      uses: actions/download-artifact@v4
      with:
        name: Scanner Reports

    - name: ğŸ” Verify Scan Reports Exist
      run: |
        echo "ğŸ”¹ Checking for scan reports..."
        ls -lah || echo "âš ï¸ WARNING: No scan reports found!"

    - name: ğŸ›  Install MySQL Connector
      run: |
        python -m pip install --upgrade pip
        pip install mysql-connector-python

    - name: ğŸ—„ Wait for Local MySQL to Be Ready
      run: |
        for i in {1..30}; do
          if mysql -h 192.168.1.5 -u flask_user -pAbhiram@1729 -e "SELECT 1"; then
            echo "âœ… MySQL is ready!"
            break
          fi
          echo "â³ Waiting for MySQL..."
          sleep 2
        done

    - name: ğŸ—„ Store Scan Data in Local MySQL
      run: python insert_scan_report.py
